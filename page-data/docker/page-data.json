{"componentChunkName":"component---src-templates-note-template-tsx","path":"/docker/","result":{"data":{"markdownRemark":{"html":"<h2>install</h2>\n<p><a href=\"https://allysonjulian.com/posts/setting-up-docker-with-xhyve/\">https://allysonjulian.com/posts/setting-up-docker-with-xhyve/</a></p>\n<p><a href=\"https://docs.docker.com/v17.12/docker-for-mac/install/#download-docker-for-mac\">https://docs.docker.com/v17.12/docker-for-mac/install/#download-docker-for-mac</a></p>\n<pre><code class=\"language-bash\">brew update\nbrew install docker docker-compose docker-machine\n</code></pre>\n<h3><del>xhyve</del></h3>\n<p><em>deprecated, use hyperkit</em></p>\n<pre><code class=\"language-bash\">docker-machine-driver-xhyve\n\ndocker-machine env dev\n</code></pre>\n<h3>hyperkit</h3>\n<p><a href=\"https://github.com/kubernetes/minikube/blob/master/docs/drivers.md#hyperkit-driver\">https://github.com/kubernetes/minikube/blob/master/docs/drivers.md#hyperkit-driver</a></p>\n<pre><code class=\"language-bash\">curl -LO https://storage.googleapis.com/minikube/releases/latest/docker-machine-driver-hyperkit \\\n&#x26;&#x26; sudo install -o root -g wheel -m 4755 docker-machine-driver-hyperkit /usr/local/bin/\n</code></pre>\n<p>or</p>\n<pre><code class=\"language-bash\">docker-machine-driver-hyperkit\ndocker-machine create dev --driver hyperkit\n</code></pre>\n<h2>Docker</h2>\n<p><code>docker exec -it vibrant_bell sh</code></p>\n<blockquote>\n<p>run shell on container vibrant_bell</p>\n</blockquote>\n<h3>Healthchecks</h3>\n<p><strong>documentation</strong>: <a href=\"https://docs.docker.com/engine/reference/builder/#healthcheck\">https://docs.docker.com/engine/reference/builder/#healthcheck</a></p>\n<p><a href=\"https://ryaneschinger.com/blog/using-docker-native-health-checks/\">https://ryaneschinger.com/blog/using-docker-native-health-checks/</a></p>\n<p><strong>health check samples:</strong> <a href=\"https://github.com/docker-library/healthcheck\">https://github.com/docker-library/healthcheck</a></p>\n<h3>Startup dependencies</h3>\n<p><a href=\"https://docs.docker.com/compose/startup-order/\">https://docs.docker.com/compose/startup-order/</a></p>\n<h3>compose / stack</h3>\n<p>compose is legacy</p>\n<p>links are legacy.</p>\n<p><code>docker container run --name api-gateway --rm --link config-service:ali-config-service api-gateway:latest</code></p>\n<p>start stack</p>\n<p><code>docker stack deploy -c docker-compose.yml javelin</code></p>\n<h3>ENV vars</h3>\n<p>how entry points work: <a href=\"https://stackoverflow.com/questions/41512237/how-to-execute-a-shell-command-before-the-entrypoint-via-the-dockerfile\">https://stackoverflow.com/questions/41512237/how-to-execute-a-shell-command-before-the-entrypoint-via-the-dockerfile</a></p>\n<p>vars in dockerfile: <a href=\"https://stackoverflow.com/questions/19537645/get-environment-variable-value-in-dockerfile\">https://stackoverflow.com/questions/19537645/get-environment-variable-value-in-dockerfile</a></p>\n<p>environment replacement doc: <a href=\"https://docs.docker.com/engine/reference/builder/#environment-replacement\">https://docs.docker.com/engine/reference/builder/#environment-replacement</a></p>\n<p><strong>how to run command to set env var</strong></p>\n<ol>\n<li>\n<p>Create dockerrun.sh script to set as entry point with the following</p>\n<pre><code class=\"language-text\">GATEWAY=$(ip route show 0.0.0.0/0 dev eth0 | cut -d\\  -f3)\nSPRING_CONFIG_URI=http://$GATEWAY:8888\njava $JAVA_OPTS -DSPRING_CONFIG_URI=$SPRING_CONFIG_URI -Djava.security.egd=file:/dev/./urandom -Dserver.port=8081 -jar /app.jar\n</code></pre>\n</li>\n<li>\n<p>edit Dockerfile</p>\n<pre><code class=\"language-text\">FROM openjdk:8-jdk-alpine\nVOLUME /tmp\nEXPOSE 8081\nCOPY target/dockerrun.sh /\nADD target/api-gateway.jar app.jar\nENV JAVA_OPTS=\"\"\nENTRYPOINT exec sh ./dockerrun.sh\n</code></pre>\n</li>\n<li></li>\n</ol>\n<h3>Networking</h3>\n<p>docs: <a href=\"https://docs.docker.com/engine/userguide/networking/work-with-networks/#basic-container-networking-example\">https://docs.docker.com/engine/userguide/networking/work-with-networks/#basic-container-networking-example</a></p>\n<p><strong>get container ip</strong></p>\n<pre><code class=\"language-text\">hostname -i\n</code></pre>\n<p><strong>get container gateway</strong></p>\n<pre><code class=\"language-text\">$(ip route show 0.0.0.0/0 dev eth0 | cut -d\\  -f3)\n</code></pre>\n<p>or</p>\n<pre><code class=\"language-text\">ip route|awk '/default/ { print $3 }'\n</code></pre>\n<p>** Use docker compose/stacks to network containers. old way was link. using the gateway address will also do it.</p>\n<h3>tutorials</h3>\n<p><strong>getting started for java:</strong> <a href=\"https://github.com/docker/labs/tree/master/developer-tools/java/\">https://github.com/docker/labs/tree/master/developer-tools/java/</a></p>\n<p><strong>getting started for spring boot:</strong> <a href=\"https://spring.io/guides/gs/spring-boot-docker/\">https://spring.io/guides/gs/spring-boot-docker/</a></p>\n<p><strong>host multiple websites on single host docker:</strong> <a href=\"https://blog.florianlopes.io/host-multiple-websites-on-single-host-docker/\">https://blog.florianlopes.io/host-multiple-websites-on-single-host-docker/</a></p>\n<p><strong>nginx template vars:</strong> <a href=\"https://docs.docker.com/samples/library/nginx/#using-environment-variables-in-nginx-configuration\">https://docs.docker.com/samples/library/nginx/#using-environment-variables-in-nginx-configuration</a></p>\n<h3>phantomjs</h3>\n<p><a href=\"http://fabiorehm.com/blog/2015/07/22/building-a-minimum-viable-phantomjs-2-docker-image/\">http://fabiorehm.com/blog/2015/07/22/building-a-minimum-viable-phantomjs-2-docker-image/</a></p>\n<p>alpine linux won't build phantom:</p>\n<p><a href=\"https://github.com/Overbryd/docker-phantomjs-alpine\">https://github.com/Overbryd/docker-phantomjs-alpine</a></p>\n<h3>Playground</h3>\n<p><a href=\"http://play-with-docker.com\">http://play-with-docker.com</a></p>\n<h3>Volumes</h3>\n<ul>\n<li>mount points are owned by root, may have implications when mounting user home\n<ul>\n<li>create a VOLUME and run ls -la /home</li>\n<li>add a volume at run to /home/username and run ls -la /home to see diff</li>\n<li>paths on host must be absolute.</li>\n<li>non-existent paths are created</li>\n</ul>\n</li>\n</ul>\n<h4>Mac OS</h4>\n<p><a href=\"https://docs.docker.com/docker-for-mac/osxfs/#namespaces\">https://docs.docker.com/docker-for-mac/osxfs/#namespaces</a></p>\n<h3>Alpine linux</h3>\n<p>docs: <a href=\"https://docs.docker.com/samples/library/alpine/\">https://docs.docker.com/samples/library/alpine/ </a></p>\n<p>creating users: <a href=\"https://github.com/mhart/alpine-node/issues/48\">https://github.com/mhart/alpine-node/issues/48 </a></p>\n<pre><code class=\"language-text\">RUN addgroup -g 1000 -S username &#x26;&#x26; \\\n    adduser -u 1000 -S username -G username\n</code></pre>\n<h3>montoring</h3>\n<p><a href=\"http://fuzzyblog.io/blog/docker/2017/06/25/docker-tutorial-understanding-container-memory-usage.html\">http://fuzzyblog.io/blog/docker/2017/06/25/docker-tutorial-understanding-container-memory-usage.html</a></p>\n<p><a href=\"https://dzone.com/articles/monitoring-docker-containers-docker-stats-cadvisor-1\">https://dzone.com/articles/monitoring-docker-containers-docker-stats-cadvisor-1</a> - breakdown of four types of monitoring including: stats, cadvisor, remote api, and universal control plane</p>\n<p><strong>docker stats</strong></p>\n<p>is a live 1sec view that streams</p>\n<pre><code class=\"language-text\">docker stats\n</code></pre>\n<p><strong>docker remote api</strong></p>\n<p><a href=\"https://docs.docker.com/develop/sdk/\">https://docs.docker.com/develop/sdk/</a> - sdk for interacting</p>\n<p><a href=\"https://docs.docker.com/engine/api/v1.37/\">https://docs.docker.com/engine/api/v1.37/</a> - api docs</p>\n<p><strong>using cAdvisor</strong></p>\n<p>This will run in a docker container and expose a web view at: localhost:8080</p>\n<pre><code class=\"language-text\">#!/usr/bin/env bash\ndocker run -d --name=cadvisor \\\n    -p 8081:8080 \\\n    --volume=/var/run:/var/run:rw \\\n    --volume=/sys:/sys:ro \\\n    --volume=/var/lib/docker/:/var/lib/docker:ro \\\n    google/cadvisor:latest\n</code></pre>\n<p>Gives you host and container metrics such as:<br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/d0c908744bc0f78e526024ea1acf81a1/eb4a1/cadvisor-docker-container-metrics.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.25766871165644%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB4klEQVR42q2SvW/UQBDF7/8vkGgpEJSpaZFAUFAiUSVSSLiQYN+dvV/2rvfTP7R7FyCEAiFGGs96PPu8773dPDl7w9NXH3n2+pyX76958e7qn/L528+cfdiyWZxl0pLgF/5HbOqjlELKmfyH2jKXR737dcyZkAplXVtuUkrknFlPjQpeo4LAyvGHK7msbaZmjfu6hIya46kHmxBCA6wAcooIE9E2tSEfy2md0HMixOPmJRScz8xLbvN13wPK61qIqaAnz+3OoKbIIC3SeITxDHJmcolRO0bl0HNkEDNyCgi9oKef+m+MMZhpwlmL9x7nbKPjnCPGSC4ZpTTWuvY9eN9ksXZuzCrDxbmfgH2/4zAMCCHbAD+Uexj3mv2Vy82QUo3JpBSae2splJQoMba6Np1ze1+rka1/ypORDbACxZQIs4T5wKA6BuOJUpKMJvvAIvYsYmQSglkoSvAk58jLQnKWvPxCuepy1E6300ndo9REOOxYo29D8luH7jqWQ4fV81GC06kquxzDb5RLQSnB9c1XthefGLfnDN0l2uwxTnN9eUHf3bC/vaK/+4LzE0ofMLNg1AOjGR8DhhRRWjIMe0Jw7EdB13dIMXB3u8XokX7X0e/vUFog5QFr6w3R7ZbcA34H3ZLpRRcaU+wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Cadvisor Docker Container Metrics\"\n        title=\"\"\n        src=\"/notes/static/d0c908744bc0f78e526024ea1acf81a1/a6d36/cadvisor-docker-container-metrics.png\"\n        srcset=\"/notes/static/d0c908744bc0f78e526024ea1acf81a1/222b7/cadvisor-docker-container-metrics.png 163w,\n/notes/static/d0c908744bc0f78e526024ea1acf81a1/ff46a/cadvisor-docker-container-metrics.png 325w,\n/notes/static/d0c908744bc0f78e526024ea1acf81a1/a6d36/cadvisor-docker-container-metrics.png 650w,\n/notes/static/d0c908744bc0f78e526024ea1acf81a1/e548f/cadvisor-docker-container-metrics.png 975w,\n/notes/static/d0c908744bc0f78e526024ea1acf81a1/eb4a1/cadvisor-docker-container-metrics.png 1083w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Can be used with other tools for storage and retrieval. docs: <a href=\"https://github.com/google/cadvisor/blob/master/docs/storage/README.md\">https://github.com/google/cadvisor/blob/master/docs/storage/README.md</a></p>\n<h3>Caching/Layers</h3>\n<p><a href=\"https://thenewstack.io/understanding-the-docker-cache-for-faster-builds/\">https://thenewstack.io/understanding-the-docker-cache-for-faster-builds/</a></p>\n<p><a href=\"https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#run\">https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#run</a></p>\n<p>brute force: â€“no-cache during build</p>\n<p>use multi-stage builds and separate layers correctly</p>\n<h2>fix terminal size</h2>\n<p>fix issue where terminal has wierd wraps</p>\n<pre><code class=\"language-bash\">docker exec -e COLUMNS=\"`tput cols`\" -e LINES=\"`tput lines`\" -ti mycontainer bash\n</code></pre>\n<h2>interactive experimenting</h2>\n<p>run an alipine linux container in interactive shell</p>\n<pre><code class=\"language-bash\">docker run -it alpine:3.9 /bin/bash\n</code></pre>","frontmatter":{"date":"April 10, 2019","title":"Docker","tags":["nix"]}}},"pageContext":{"slug":"/docker/"}},"staticQueryHashes":["1865044719","3489759178","3649515864"],"slicesMap":{}}