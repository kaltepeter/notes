---
title: Working with Django Models
date: 2025-06-13
tags:
  - course
  - pluralsight
  - python
  - django
---

https://app.pluralsight.com/library/courses/django-models/table-of-contents

https://github.com/codesensei-courses/django-models

## Models

- Python classes that are mapped to database tables
- Migrations are python scripts that keep db strucuture in sync with code, autogenerated most of the time
- Models are defined in `models.py` or `models/*.py`
- Models use Fields to define the types

## Fields

- Floating points have rounding issues: https://docs.python.org/3.10/tutorial/floatingpoint.html, use DecimalField instead


## Postgres

```bash
python -m pip install psycopg2
```

```python
# settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'carved_rock',
    }
}
```

## Logging

- Logs all sql
- Bad practice in production

```python
# settings.py
LOGGING = {
    "version": 1,
    "handlers": {"console": {"class": "logging.StreamHandler"}},
    "loggers": {"django.db.backends": {"level": "DEBUG"}},
    "root": {"handlers": ["console"]},
}
```

## Basic ORM

```python
>>> from store.models import Product
>>> p = Product(name="Hiking Boots", price=100, stock_count=50)
>>> p
<Product: Product object (None)>
>>> p.id
>>> p.save()
(0.002) INSERT INTO "store_product" ("name", "stock_count", "price") VALUES ('Hiking Boots', 50, '100') RETURNING "store_product"."id"; args=('Hiking Boots', 50, Decimal('100')); alias=default
>>> p.id
1
>>> p.price=80
>>> p.save()
(0.002) UPDATE "store_product" SET "name" = 'Hiking Boots', "stock_count" = 50, "price" = '80' WHERE "store_product"."id" = 1; args=('Hiking Boots', 50, Decimal('80'), 1); alias=default
>>> p.delete()
(0.002) DELETE FROM "store_product" WHERE "store_product"."id" IN (1); args=(1,); alias=default
(1, {'store.Product': 1})
```

## Databases

- https://docs.djangoproject.com/en/3.1/ref/databases/
- https://docs.djangoproject.com/en/3.1/howto/legacy-databases/

## Django Model Fields

- https://docs.djangoproject.com/en/3.1/ref/models/fields/
- Field class determines
    - Database column type (e.g. VARCHAR, INTEGER, DATE)
    - How the field is rendered in a form
- Field options
    - DB Validation
    - Form Rendereing and Validation
    - Default value
- Types
    - BooleanField
    - IntegerField
    - FloatField
    - DecimalField
    - CharField
    - TextField
    - EmailField
    - URLField
    - FilePathField
    - SlugField
    - GenericIPAddressField
    - ForeignKey
    - ManyToManyField
    - OneToOneField

Adding a new field will result in an error:

```python
(venv) âžœ  carved_rock python manage.py makemigrations                                                                                      <aws:kayla> <region:us-east-1>
(0.002) 
            SELECT name, type FROM sqlite_master
            WHERE type in ('table', 'view') AND NOT name='sqlite_sequence'
            ORDER BY name; args=None; alias=default
(0.000) SELECT "django_migrations"."id", "django_migrations"."app", "django_migrations"."name", "django_migrations"."applied" FROM "django_migrations"; args=(); alias=default
It is impossible to add a non-nullable field 'description' to product without specifying a default. This is because the database needs something to populate existing rows.
Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows with a null value for this column)
 2) Quit and manually define a default value in models.py.
```

Adding `description = models.TextField(default="")` will allow it to succeed.

- `blank=True` allows the field to be empty in the form. Does not require a migration or affect the database.
- `null=True` allows the field to be empty in the database. Requires a migration.
- `unique=True` makes the field unique. Requires a migration.
- `db_index=True` adds an index to the field. Requires a migration.
- `db_column='my_column'` changes the column name in the database. Requires a migration.
- `auto_now=True` for date, use now
- `verbose_name="Bank Acount"` change the name of the form text.
- `help_text="Enter your bank account number"` change the help text for the form.

```python
class ProductImage(models.Model):
    image = models.ImageField()
    product = models.ForeignKey('Product', on_delete=models.CASCADE)


class Category(models.Model):
    name = models.CharField(max_length=100)
    product = models.ManyToManyField('Product')
```

- For other objects a string is safer to avoid load error orders, for example in a foriegn key.
- One to One is similar to a foreign key with a unique constraint.

Adding the `__str__` method changes the admin display.

```python
def __str__(self):
        return self.name
```

## Managers and QuerySets

- Managers are used to query the database.
- QuerySets are lazy, the shell will run immediately due to the automatic print
- Because querysets are lazy, you can chaing them to build more complex queries.
- https://docs.djangoproject.com/en/3.1/ref/models/querysets/

```python
>>> from store.models import Product
>>> Product.objects.all()
(0.001) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" LIMIT 21; args=(); alias=default
<QuerySet [<Product: Yoga mat>, <Product: Backpack>, <Product: Helmet>, <Product: Kayak>]>
>>> Product.objects.get(pk=1)
(0.002) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE "store_product"."id" = 1 LIMIT 21; args=(1,); alias=default
<Product: Yoga mat>
>>> Product.objects
<django.db.models.manager.Manager object at 0x10357d790>
```

### Filter

```python
def category_view(request, name):
    products = Product.objects.filter(category__name=name)
    
    return render(request, "store/category.html",
                  {'products': products,
                   'category_name': name})
```

`category__name` is a lookup.

```python
>>> Product.objects.filter(name="Kayak")
(0.004) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE "store_product"."name" = 'Kayak' LIMIT 21; args=('Kayak',); alias=default
<QuerySet [<Product: Kayak>]>

>>> Product.objects.filter(name__endswith="k")
(0.001) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE "store_product"."name" LIKE '%k' ESCAPE '\' LIMIT 21; args=('%k',); alias=default
<QuerySet [<Product: Backpack>, <Product: Kayak>]>f

>>> Product.objects.filter(name__contains="a", price__lt=100)
(0.001) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE ("store_product"."name" LIKE '%a%' ESCAPE '\' AND "store_product"."price" < '100') LIMIT 21; args=('%a%', Decimal('100')); alias=default
<QuerySet [<Product: Yoga mat>]>

>>> p = Product.objects.filter(name__contains="a", price__lt=100)
>>> p.count()
(0.000) SELECT COUNT(*) AS "__count" FROM "store_product" WHERE ("store_product"."name" LIKE '%a%' ESCAPE '\' AND "store_product"."price" < '100'); args=('%a%', Decimal('100')); alias=default
1
>>> p.exclude(stock_count__gt=5)
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE ("store_product"."name" LIKE '%a%' ESCAPE '\' AND "store_product"."price" < '100' AND NOT ("store_product"."stock_count" > 5)) LIMIT 21; args=('%a%', Decimal('100'), 5); alias=default
<QuerySet []>

>>> Product.objects.filter(category__name="Climbing gear")
(0.001) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" INNER JOIN "store_category_product" ON ("store_product"."id" = "store_category_product"."product_id") INNER JOIN "store_category" ON ("store_category_product"."category_id" = "store_category"."id") WHERE "store_category"."name" = 'Climbing gear' LIMIT 21; args=('Climbing gear',); alias=default
<QuerySet []>

>>> Product.objects.filter(category__name__contains="gear")
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" INNER JOIN "store_category_product" ON ("store_product"."id" = "store_category_product"."product_id") INNER JOIN "store_category" ON ("store_category_product"."category_id" = "store_category"."id") WHERE "store_category"."name" LIKE '%gear%' ESCAPE '\' LIMIT 21; args=('%gear%',); alias=default
<QuerySet [<Product: Backpack>, <Product: Helmet>, <Product: Helmet>]>


```

### Relationships

- Use `<related>_id` insteawd of `<related>` to avoid errors and check if the relationship exists.
- Saving relationships must be in the correct order.


```python
# relationshps for new items
>>> i = ProductImage(image="somefile.jpg")
>>> i.product
Traceback (most recent call last):
  File "<console>", line 1, in <module>
  File "/Users/kayla.altepeter/data/tutorials/django-models-m3-model-classes/carved_rock/venv/lib/python3.12/site-packages/django/db/models/fields/related_descriptors.py", line 271, in __get__
    raise self.RelatedObjectDoesNotExist(
store.models.ProductImage.product.RelatedObjectDoesNotExist: ProductImage has no product.. Did you mean: 'product_id'?
>>> i.product_id
>>> i.product_id is None
True

# saving relationships
>>> from decimal import Decimal
>>> p = Product(name="example", stock_count=1, price=Decimal(100), sku=("example01"))
>>> i.product = p
>>> i.save()
Traceback (most recent call last):
  File "<console>", line 1, in <module>
  File "/Users/kayla.altepeter/data/tutorials/django-models-m3-model-classes/carved_rock/venv/lib/python3.12/site-packages/django/db/models/base.py", line 857, in save
    self._prepare_related_fields_for_save(operation_name="save")
  File "/Users/kayla.altepeter/data/tutorials/django-models-m3-model-classes/carved_rock/venv/lib/python3.12/site-packages/django/db/models/base.py", line 1242, in _prepare_related_fields_for_save
    raise ValueError(
ValueError: save() prohibited to prevent data loss due to unsaved related object 'product'.

>>> p.save()
(0.005) INSERT INTO "store_product" ("name", "stock_count", "price", "description", "sku") VALUES ('example', 1, '100', '', 'example01') RETURNING "store_product"."id"; args=('example', 1, Decimal('100'), '', 'example01'); alias=default
>>> i.save()
(0.002) INSERT INTO "store_productimage" ("image", "product_id") VALUES ('somefile.jpg', 5) RETURNING "store_productimage"."id"; args=('somefile.jpg', 5); alias=default

```

### Aggregates

```python
>>> from django.db.models import Avg, Count
>>> Product.objects.aggregate(Avg('price'))
(0.000) SELECT (CAST(AVG("store_product"."price") AS NUMERIC)) AS "price__avg" FROM "store_product"; args=(); alias=default
{'price__avg': Decimal('117.200000000000')}

>>> Category.objects.annotate(Avg('products__price'))
(0.000) SELECT "store_category"."id", "store_category"."name", (CAST(AVG("store_product"."price") AS NUMERIC)) AS "products__price__avg" FROM "store_category" LEFT OUTER JOIN "store_category_products" ON ("store_category"."id" = "store_category_products"."category_id") LEFT OUTER JOIN "store_product" ON ("store_category_products"."product_id" = "store_product"."id") GROUP BY "store_category"."id", "store_category"."name" LIMIT 21; args=(); alias=default
<QuerySet [<Category: Climbing Gear>, <Category: Safety Gear>]>

>>> Category.objects.annotate(Avg('products__price')).values()
(0.000) SELECT "store_category"."id", "store_category"."name", (CAST(AVG("store_product"."price") AS NUMERIC)) AS "products__price__avg" FROM "store_category" LEFT OUTER JOIN "store_category_products" ON ("store_category"."id" = "store_category_products"."category_id") LEFT OUTER JOIN "store_product" ON ("store_category_products"."product_id" = "store_product"."id") GROUP BY "store_category"."id", "store_category"."name" LIMIT 21; args=(); alias=default
<QuerySet [{'id': 1, 'name': 'Climbing Gear', 'products__price__avg': Decimal('91')}, {'id': 2, 'name': 'Safety Gear', 'products__price__avg': Decimal('32')}]>

>>> Category.objects.annotate(avg_price=Avg('products__price')).values()
(0.002) SELECT "store_category"."id", "store_category"."name", (CAST(AVG("store_product"."price") AS NUMERIC)) AS "avg_price" FROM "store_category" LEFT OUTER JOIN "store_category_products" ON ("store_category"."id" = "store_category_products"."category_id") LEFT OUTER JOIN "store_product" ON ("store_category_products"."product_id" = "store_product"."id") GROUP BY "store_category"."id", "store_category"."name" LIMIT 21; args=(); alias=default
<QuerySet [{'id': 1, 'name': 'Climbing Gear', 'avg_price': Decimal('91')}, {'id': 2, 'name': 'Safety Gear', 'avg_price': Decimal('32')}]>

>>> Category.objects.annotate(avg_price=Avg('products__price')).values().order_by('avg_price')
(0.000) SELECT "store_category"."id", "store_category"."name", (CAST(AVG("store_product"."price") AS NUMERIC)) AS "avg_price" FROM "store_category" LEFT OUTER JOIN "store_category_products" ON ("store_category"."id" = "store_category_products"."category_id") LEFT OUTER JOIN "store_product" ON ("store_category_products"."product_id" = "store_product"."id") GROUP BY "store_category"."id", "store_category"."name" ORDER BY 3 ASC LIMIT 21; args=(); alias=default
<QuerySet [{'id': 2, 'name': 'Safety Gear', 'avg_price': Decimal('32')}, {'id': 1, 'name': 'Climbing Gear', 'avg_price': Decimal('91')}]>

>>> Product.objects.annotate(cat_count=Count('categories')).filter(cat_count__gt=1)
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku", COUNT("store_category_products"."category_id") AS "cat_count" FROM "store_product" LEFT OUTER JOIN "store_category_products" ON ("store_product"."id" = "store_category_products"."product_id") GROUP BY "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" HAVING COUNT("store_category_products"."category_id") > 1 LIMIT 21; args=(1,); alias=default
<QuerySet [<Product: Helmet>]>
 
```

### F expressions

- reference to the value of a field
- Fast due to being executed in the database

```python
# find all products with the name in the description
>>> from django.db.models import F
>>> Product.objects.filter(description__contains=F('name'))
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE "store_product"."description" LIKE '%%' || REPLACE(REPLACE(REPLACE(("store_product"."name"), '\', '\\'), '%%', '\%%'), '_', '\_') || '%%' ESCAPE '\' LIMIT 21; args=(); alias=default
<QuerySet []>

# update all prices for a category
>>> Category.objects.get(name='Climbing Gear')
(0.000) SELECT "store_category"."id", "store_category"."name" FROM "store_category" WHERE "store_category"."name" = 'Climbing Gear' LIMIT 21; args=('Climbing Gear',); alias=default
<Category: Climbing Gear>
>>> Category.objects.get(name='Climbing Gear').products.update(price=F('price')*.9)
(0.000) SELECT "store_category"."id", "store_category"."name" FROM "store_category" WHERE "store_category"."name" = 'Climbing Gear' LIMIT 21; args=('Climbing Gear',); alias=default
(0.007) UPDATE "store_product" SET "price" = ("store_product"."price" * 0.9) WHERE "store_product"."id" IN (SELECT U0."id" FROM "store_product" U0 INNER JOIN "store_category_products" U1 ON (U0."id" = U1."product_id") WHERE U1."category_id" = 1); args=(0.9, 1); alias=default
2

# add euros
>>> from django.db.models import F, DecimalField, ExpressionWrapper
>>> Product.objects.annotate(price_eur=ExpressionWrapper(F('price')*1.1, output_field=DecimalField())).values() 
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku", (CAST(("store_product"."price" * 1.1) AS NUMERIC)) AS "price_eur" FROM "store_product" LIMIT 21; args=(1.1,); alias=default
<QuerySet [{'id': 1, 'name': 'Yoga mat', 'stock_count': 1000, 'price': Decimal('25.00'), 'description': '', 'sku': '', 'price_eur': Decimal('27.5000000000000')}, {'id': 2, 'name': 'Backpack', 'stock_count': 25, 'price': Decimal('135.00'), 'description': '', 'sku': 'bpk092', 'price_eur': Decimal('148.5')}, {'id': 3, 'name': 'Helmet', 'stock_count': 15, 'price': Decimal('28.80'), 'description': '', 'sku': 'hlmt03', 'price_eur': Decimal('31.6800000000000')}, {'id': 4, 'name': 'Kayak', 'stock_count': 3, 'price': Decimal('279.00'), 'description': '', 'sku': 'ky002', 'price_eur': Decimal('306.900000000000')}, {'id': 5, 'name': 'example', 'stock_count': 1, 'price': Decimal('100.00'), 'description': '', 'sku': 'example01', 'price_eur': Decimal('110.000000000000')}]>
```

### Q expressions

- `~` negates the expression
- `Q` builds expressions
- default quries are all 'AND'
- `|` is an or
- `&` is an and

```python
>>> from django.db.models import Q
# in stock
>>> in_stock = Q(stock_count__gt=0)

# no image
>>> no_img = Q(images=None)

# find all in stock
>>> Product.objects.filter(in_stock)
(0.001) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE "store_product"."stock_count" > 0 LIMIT 21; args=(0,); alias=default
<QuerySet [<Product: Yoga mat>, <Product: Backpack>, <Product: Helmet>, <Product: Kayak>, <Product: example>]>

# find all no image
>>> Product.objects.filter(no_img)
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" LEFT OUTER JOIN "store_productimage" ON ("store_product"."id" = "store_productimage"."product_id") WHERE "store_productimage"."id" IS NULL LIMIT 21; args=(); alias=default
<QuerySet [<Product: Yoga mat>]>

# find all out of stock
>>> Product.objects.filter(~in_stock)
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE NOT ("store_product"."stock_count" > 0) LIMIT 21; args=(0,); alias=default
<QuerySet []>

# out of stock or have no images
>>> Product.objects.filter(no_img|~in_stock)
(0.001) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" LEFT OUTER JOIN "store_productimage" ON ("store_product"."id" = "store_productimage"."product_id") WHERE ("store_productimage"."id" IS NULL OR NOT ("store_product"."stock_count" > 0)) LIMIT 21; args=(0,); alias=default
<QuerySet [<Product: Yoga mat>]>

# find out of stock and no image
>>> Product.objects.filter(no_img&~in_stock)
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" LEFT OUTER JOIN "store_productimage" ON ("store_product"."id" = "store_productimage"."product_id") WHERE ("store_productimage"."id" IS NULL AND NOT ("store_product"."stock_count" > 0)) LIMIT 21; args=(0,); alias=default
<QuerySet []>

# store in var
no_img_or_no_stock = no_img|~in_stock
```

### Examples

```python
>>> Product.objects.all()[:5]
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" LIMIT 5; args=(); alias=default
<QuerySet [<Product: Yoga mat>, <Product: Backpack>, <Product: Helmet>, <Product: Kayak>]>

>>> Product.objects.reverse()[0]
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM 

>>> Product.objects.reverse().first()
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" ORDER BY "store_product"."id" DESC LIMIT 1; args=(); alias=default
<Product: Kayak>

>>> Product.objects.order_by("price")
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" ORDER BY "store_product"."price" ASC LIMIT 21; args=(); alias=default
<QuerySet [<Product: Yoga mat>, <Product: Helmet>, <Product: Backpack>, <Product: Kayak>]>

>>> Product.objects.order_by("price").values()
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" ORDER BY "store_product"."price" ASC LIMIT 21; args=(); alias=default
<QuerySet [{'id': 1, 'name': 'Yoga mat', 'stock_count': 1000, 'price': Decimal('25.00'), 'description': '', 'sku': ''}, {'id': 3, 'name': 'Helmet', 'stock_count': 15, 'price': Decimal('32.00'), 'description': '', 'sku': 'hlmt03'}, {'id': 2, 'name': 'Backpack', 'stock_count': 25, 'price': Decimal('150.00'), 'description': '', 'sku': 'bpk092'}, {'id': 4, 'name': 'Kayak', 'stock_count': 3, 'price': Decimal('279.00'), 'description': '', 'sku': 'ky002'}]>

>>> Product.objects.order_by("price").values_list()
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" ORDER BY "store_product"."price" ASC LIMIT 21; args=(); alias=default
<QuerySet [(1, 'Yoga mat', 1000, Decimal('25.00'), '', ''), (3, 'Helmet', 15, Decimal('32.00'), '', 'hlmt03'), (2, 'Backpack', 25, Decimal('150.00'), '', 'bpk092'), (4, 'Kayak', 3, Decimal('279.00'), '', 'ky002')]>

>>> Product.objects.filter(category__name__contains="gear").distinct()
(0.001) SELECT DISTINCT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" INNER JOIN "store_category_product" ON ("store_product"."id" = "store_category_product"."product_id") INNER JOIN "store_category" ON ("store_category_product"."category_id" = "store_category"."id") WHERE "store_category"."name" LIKE '%gear%' ESCAPE '\' LIMIT 21; args=('%gear%',); alias=default
<QuerySet [<Product: Backpack>, <Product: Helmet>]>

>>> Product.objects.get(pk=5)
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE "store_product"."id" = 5 LIMIT 21; args=(5,); alias=default
Traceback (most recent call last):
  File "<console>", line 1, in <module>
  File "/Users/kayla.altepeter/data/tutorials/django-models-m3-model-classes/carved_rock/venv/lib/python3.12/site-packages/django/db/models/manager.py", line 87, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kayla.altepeter/data/tutorials/django-models-m3-model-classes/carved_rock/venv/lib/python3.12/site-packages/django/db/models/query.py", line 633, in get
    raise self.model.DoesNotExist(
store.models.Product.DoesNotExist: Product matching query does not exist.
>>> Product.objects.get(pk=2)
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE "store_product"."id" = 2 LIMIT 21; args=(2,); alias=default
<Product: Backpack>

>>> from store.models import Category
>>> c = Category.objects.get(pk=1)
(0.001) SELECT "store_category"."id", "store_category"."name" FROM "store_category" WHERE "store_category"."id" = 1 LIMIT 21; args=(1,); alias=default

c.product
<django.db.models.fields.related_descriptors.create_forward_many_to_many_manager.<locals>.ManyRelatedManager object at 0x103914710>

>>> c.product.all()
(0.001) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" INNER JOIN "store_category_product" ON ("store_product"."id" = "store_category_product"."product_id") WHERE "store_category_product"."category_id" = 1 LIMIT 21; args=(1,); alias=default
<QuerySet [<Product: Backpack>, <Product: Helmet>]>

>>> c.product.filter(price__lt=10)
(0.001) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" INNER JOIN "store_category_product" ON ("store_product"."id" = "store_category_product"."product_id") WHERE ("store_category_product"."category_id" = 1 AND "store_product"."price" < '10') LIMIT 21; args=(1, Decimal('10')); alias=default
<QuerySet []>

>>> p = Product.objects.get(name="Helmet")
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE "store_product"."name" = 'Helmet' LIMIT 21; args=('Helmet',); alias=default
>>> p
<Product: Helmet>
>>> p.category_set
<django.db.models.fields.related_descriptors.create_forward_many_to_many_manager.<locals>.ManyRelatedManager object at 0x1037a3fb0>
>>> p.category_set.all()
(0.002) SELECT "store_category"."id", "store_category"."name" FROM "store_category" INNER JOIN "store_category_product" ON ("store_category"."id" = "store_category_product"."category_id") WHERE "store_category_product"."product_id" = 3 LIMIT 21; args=(3,); alias=default
<QuerySet [<Category: Climbing Gear>, <Category: Safety Gear>]>

>>> i = ProductImage.objects.get(pk=1)
(0.001) SELECT "store_productimage"."id", "store_productimage"."image", "store_productimage"."product_id" FROM "store_productimage" WHERE "store_productimage"."id" = 1 LIMIT 21; args=(1,); alias=default
>>> i.product
(0.000) SELECT "store_product"."id", "store_product"."name", "store_product"."stock_count", "store_product"."price", "store_product"."description", "store_product"."sku" FROM "store_product" WHERE "store_product"."id" = 2 LIMIT 21; args=(2,); alias=default
<Product: Backpack>
>>> i.product_id
2

```

## Customizing Model Behavior

- https://docs.djangoproject.com/en/3.1/ref/models/options/
- Add Meta class to Django models

### Sorting

- Can hurt performance
- Sorts always
- `-` is descending order

```python
class Meta:
        ordering = ['price']
        # ordering = ['price', 'name'] # sort by price then name
        # ordering = ['-price'] # descending order
```

### Renaming

- rename the plural

```python
class Meta:
    verbose_name_plural = "Categories"
    ordering = ['name']
```

### Constraints

- require non negative price
- requires migration

```python
class Meta:
    constraints = [
        models.CheckConstraint(
            check=models.Q(price__gte=0),
            name='price_not_negative'
        )
    ]
```

### Custom Methods

- add a method to be used in views/etc.
- Look at a pattern called Fat Models, Skinny Views
- Don't create god objects (do everything)
- Overriding save is quite common

```python
@property
def vat(self):
    return Decimal(0.2) * self.price

def get_absolute_url(self):
    return reverse('store:product-detail', kwargs={'pk': self.id})

# add a slug field and create if not passed
slug = models.SlugField()

def save(self, *args, **kwargs):
    if not self.slug:
        self.slug = slugify(self.name)
    return super().save(*args, **kwargs)
```

### Custom Managers

- custom managers are now the default query
- use an alternate name to avoid issues
- https://docs.djangoproject.com/en/5.2/topics/db/managers/
- 

```python
class ProductIsInStockQuerySet(models.QuerySet):
    def in_stock(self):
        return self.filter(stock_count__gt=0)


class Product(models.Model):
    name = models.CharField(max_length=100)
    stock_count = models.IntegerField(help_text="How many items are currently in stock?")
    price = models.DecimalField(max_digits=6, decimal_places=2)
    description = models.TextField(default="", blank=True)
    sku = models.CharField(max_length=20, unique=True, verbose_name="Stock Keeping Unit")
    slug = models.SlugField()

    # The instock is now the default manager, all queries will use this. This can make it difficult if you need to query out of stock.
    # objects = ProductIsInStockQuerySet.as_manager()
    # different name for manager
    objects = models.Manager()
    in_stock = ProductIsInStockQuerySet.as_manager()

    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(self.name)
        return super().save(*args, **kwargs)

    class Meta:
        ordering = ['price']
        constraints = [
            models.CheckConstraint(
                check=models.Q(price__gte=0),
                name='price_not_negative'
            )
        ]

# query
Product.in_stock.all()
```

### Inheritance

- https://docs.djangoproject.com/en/5.2/topics/db/models/#model-inheritance
- Three styles available: Abstract, Multi-table, Proxy


#### Abstract

- [Classes for Reuse](https://github.com/jazzband/django-model-utils/tree/master/model_utils)


#### Multi-table

- Avoid model inheritance if possible

```python
class DigitalProduct(models.Model):
    file = models.FileField()


class PhysicalProduct(models.Model):
    stock_count = models.IntegerField(help_text="How many items are currently in stock?")
```

#### Proxy

- Doesn't change the model
- Add of modify behavior
- Doesn't create a table

```python
from django.db import models


class Person(models.Model):
    first_name = models.CharField(max_length=30)
    last_name = models.CharField(max_length=30)


class MyPerson(Person):
    class Meta:
        proxy = True

    def do_something(self):
        # ...
        pass
```

## Migrations

- `showmigrations` will show all, add app to filter
- `sqlmigrate store 002` show the sql for a mgiration
- `makemigrations` will create a migration, `--dry-run` won't run
- `migrate` will apply the migrations, `--fake` will make migrations but not run them
- Good idea to name migrations, renaming would have to be done for dependencies in other migrations, do this immediately to avoid issues
- State is stored in the migrations database
- `makemigrations --merge` will resolve conflicts with migrations with the same number, i.e. two people adding at the same time. Only works for different changes. 
- `squashmigrations store 0008` will squash migrations together
- https://docs.djangoproject.com/en/3.1/topics/migrations/

```bash
python manage.py showmigrations store 
python manage.py migrate store 0002 # go to previous state

# dependencies
dependencies = [
    ('store', '0001_initial'),
]
```

### Squashing

- Run the squash, test.
- Get to all environments
- Delete old files

### Custom Migrations

```bash
python manage.py makemigrations --empty store
```

```python
# Generated by Django 5.2.3 on 2025-06-17 02:24

from django.db import migrations
from django.utils.text import slugify


def slugify_product_title(apps, schema_editor):
    Product = apps.get_model('store', 'Product')
    for p in Product.objects.filter(slug=""):
        p.slug = slugify(p.name)
        p.save()


def undo_slugify(apps, schema_editor):
    pass 


class Migration(migrations.Migration):

    dependencies = [
        ('store', '0009_product_slug'),
    ]

    operations = [
        migrations.RunPython(slugify_product_title, reverse_code=undo_slugify)
    ]


```

### Fixtures
 
- `python manage.py dumpdata` will dump the data
- `python manage.py dumpdata -o fixtures/my_data.json` will dump the data
- Not super helpful in the beginning due to a lot of changes.
- https://factoryboy.readthedocs.io/en/stable/, generate data rather than fixtures

## Optimizing Models

- Avoid pre-mature optimization
- Use https://django-debug-toolbar.readthedocs.io/en/latest/ to understand queries

Don't let python do the work.

```python
# slow, uses a lot of memory
from store.models import Product

products_in_stock = []
for p in Product.objects.all():
    if p.stock_count > 0:
        products_in_stock.append(p)

# better, uses less memory
from django.db.models import F
from store.models import Product

products_in_stock = Product.objects.filter(stock_count__gt=0)
```

### QuerySets

- Querysets are lazy
- They are cached, looping over will not query.
- Slicing results in a new queryset everytime
- Relationships are lazy
- Function calls are not not cached by default, use `@cached_property` from django
- Properties are always cached

### Avoding Queries

- Using `select_related` will use an inner join
    - `img = ProductImage.objects.select_related('product').get(pk=1)`
    - Only single relations are supported
- Using `prefetch_related` will fetch many relationships data
    - `products = Product.objects.filter(name__icontains=name).prefetch_related('images')`
    - 

### Raw SQL

- Powerful
- Paramaterized queries using `%s`
    - `products = Product.objects.raw('SELECT * FROM store_product WHERE price < %s', [100])`

### Transactions

- By default Django runs in auto commit mode, if anything goes wrong the next operation doesn't run
    - `'ATOMIC_REQUESTS': True` will run in a transaction, set in the DATABASE settings
- Will use the views to ensure atomic transactions
- For small to medium size it works, slight performance hit
- https://docs.djangoproject.com/en/5.2/topics/db/transactions/